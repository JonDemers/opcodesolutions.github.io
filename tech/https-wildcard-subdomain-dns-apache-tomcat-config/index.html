<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HTTPS Wildcard Subdomain: DNS + Apache + Tomcat Config | OpCode Tech</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="HTTPS Wildcard Subdomain: DNS + Apache + Tomcat Config" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I recently had to configure HTTPS on a wildcard subdomain with Apache HTTP server as reverse proxy to a Tomcat backend. I had few more requirements:" />
<meta property="og:description" content="I recently had to configure HTTPS on a wildcard subdomain with Apache HTTP server as reverse proxy to a Tomcat backend. I had few more requirements:" />
<link rel="canonical" href="https://opcodesolutions.com/tech/https-wildcard-subdomain-dns-apache-tomcat-config/" />
<meta property="og:url" content="https://opcodesolutions.com/tech/https-wildcard-subdomain-dns-apache-tomcat-config/" />
<meta property="og:site_name" content="OpCode Tech" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-11-19T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HTTPS Wildcard Subdomain: DNS + Apache + Tomcat Config" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2014-11-19T00:00:00-05:00","datePublished":"2014-11-19T00:00:00-05:00","description":"I recently had to configure HTTPS on a wildcard subdomain with Apache HTTP server as reverse proxy to a Tomcat backend. I had few more requirements:","headline":"HTTPS Wildcard Subdomain: DNS + Apache + Tomcat Config","mainEntityOfPage":{"@type":"WebPage","@id":"https://opcodesolutions.com/tech/https-wildcard-subdomain-dns-apache-tomcat-config/"},"url":"https://opcodesolutions.com/tech/https-wildcard-subdomain-dns-apache-tomcat-config/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://opcodesolutions.com/feed.xml" title="OpCode Tech" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OpCode Tech</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tech/contact/">Contact</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HTTPS Wildcard Subdomain: DNS + Apache + Tomcat Config</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-11-19T00:00:00-05:00" itemprop="datePublished">Nov 19, 2014
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I recently had to configure HTTPS on a wildcard subdomain with Apache HTTP server as reverse proxy to a Tomcat backend. I had few more requirements:</p>

<ol>
  <li>Redirect all <strong>http</strong> traffic to <strong>https</strong> and preserve the subdomain (hostname). For instance:
    <ul>
      <li>http://<strong>sub1</strong>.example.com/ -&gt; redirect to -&gt; http<strong>s</strong>://<strong>sub1</strong>.example.com/</li>
      <li>http://<strong>sub2</strong>.example.com/ -&gt; redirect to -&gt; http<strong>s</strong>://<strong>sub2</strong>.example.com/</li>
      <li>etc.</li>
    </ul>
  </li>
  <li>I want to have a <strong>PHP</strong> wiki on the subdirectory <code class="language-plaintext highlighter-rouge">/wiki</code> and I want to send the rest of the traffic to Tomcat.</li>
  <li><strong>Tomcat</strong> needs to know the subdomain (hostname) and will serve content accordingly.</li>
  <li>I don’t know the subdomains in advance because they are <strong>chosen by users</strong>, just like *.wordpress.com</li>
</ol>

<p>Few parts were not trivial, so I will share my setup.</p>

<h2 id="dns-wildcard-subdomain-configuration">DNS Wildcard Subdomain Configuration</h2>

<p>DNS is probably the easiest part. Nowadays, most domain registrar offer good DNS support for free with your domain. If that is not the case of your registrar, you may want to consider namecheap. Their <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/597/10/how-can-i-set-up-a-catchall-wildcard-subdomain">DNS also support wildcard entries</a>. Otherwise, you can use the popular <strong>Bind DNS server</strong>. Here is how to configure a wildcard entry in BIND. Change 55.55.55.55 with your IP address.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*    IN    A    55.55.55.55
</code></pre></div></div>

<h2 id="apache-wildcard-subdomain-configuration">Apache Wildcard Subdomain Configuration</h2>

<p>This was trickier. The Apache HTTP server configuration has 2 main parts.</p>

<ol>
  <li><strong>HTTP (port 80)</strong>: We use mod_rewrite to redirect all traffic for *.example.com to https (port 443) and we preserve the hostname with the %{HTTP_HOST} variable.</li>
  <li><strong>HTTPS (port 443)</strong>: Except for the PHP subdirectory (/wiki), we reverse proxy all traffic to Tomcat, which listen on port 9090 of localhost.</li>
</ol>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Allow non-SNI clients</span>
<span class="nc">SSLStrictSNIVHostCheck</span> <span class="ss">off</span>

<span class="c"># HTTP configuration</span>
<span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:80</span><span class="p">&gt;
</span>
    <span class="nc">ServerName</span> example.com

    <span class="c"># Wildcard subdomain</span>
    <span class="nc">ServerAlias</span> *.example.com

    <span class="nc">ServerAdmin</span> info@example.com

    <span class="c"># Permanent redirect (301) to HTTPS and preserve</span>
    <span class="c"># hostname (but do not preserve path)</span>
    <span class="nc">RewriteEngine</span> <span class="ss">On</span>
    <span class="nc">RewriteRule</span> .* https://%{HTTP_HOST}/? [R=301,L]
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span>
<span class="c"># HTTPS configuration</span>
<span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:443</span><span class="p">&gt;
</span>
    <span class="nc">ServerName</span> example.com

    <span class="c"># Wildcard subdomain</span>
    <span class="nc">ServerAlias</span> *.example.com

    <span class="nc">ServerAdmin</span> info@example.com

    <span class="c"># PHP Wiki on path /wiki</span>
    <span class="nc">Alias</span> /wiki /opt/example.com/php/wiki
    <span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /opt/example.com/php/wiki</span><span class="p">&gt;
</span>        <span class="nc">AllowOverride</span> <span class="ss">All</span>
        <span class="nc">Require</span> <span class="ss">all</span> granted
    <span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
    <span class="c"># Reverse proxy everything to Tomcat except for /wiki</span>
    <span class="nc">ProxyRequests</span> <span class="ss">Off</span>
    <span class="nc">ProxyPass</span> /wiki !
    <span class="nc">ProxyPass</span> / http://localhost:9090/
    <span class="nc">ProxyPassReverse</span> / http://localhost:9090/

    <span class="c"># Logs</span>
    <span class="nc">ErrorLog</span> ${APACHE_LOG_DIR}/error.log
    <span class="nc">CustomLog</span> ${APACHE_LOG_DIR}/access.log combined

    <span class="c"># Wildcard SSL/TLS Certificate files</span>
    <span class="nc">SSLEngine</span> <span class="ss">on</span>
    <span class="nc">SSLCertificateFile</span> /etc/ssl/certs/STAR_example_com.crt
    <span class="nc">SSLCertificateKeyFile</span> /etc/ssl/private/example.key
    <span class="nc">SSLCertificateChainFile</span> /etc/ssl/certs/example.ca-bundle

    <span class="c"># Standard script config</span>
    <span class="p">&lt;</span><span class="nl">FilesMatch</span><span class="sr"> "\.(cgi|shtml|phtml|php)$"</span><span class="p">&gt;
</span>        <span class="nc">SSLOptions</span> +StdEnvVars
    <span class="p">&lt;/</span><span class="nl">FilesMatch</span><span class="p">&gt;
</span>    <span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /usr/lib/cgi-bin</span><span class="p">&gt;
</span>        <span class="nc">SSLOptions</span> +StdEnvVars
    <span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
    <span class="c"># Standard config for Internet Explorer</span>
    <span class="nc">BrowserMatch</span> "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0

    <span class="nc">BrowserMatch</span> "MSIE [17-9]" ssl-unclean-shutdown

<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div>

<h2 id="tomcat-wildcard-subdomain-configuration">Tomcat Wildcard Subdomain Configuration</h2>

<p>Below you’ll find the configuration of Tomcat (in server.xml), which is quite standard. Actually, we do not need to define any <em>“wildcard”</em>, we just define a <code class="language-plaintext highlighter-rouge">defaultHost</code> in the <code class="language-plaintext highlighter-rouge">Engine</code> element. Then we deploy a <code class="language-plaintext highlighter-rouge">ROOT.war</code> in the webapps directory (<code class="language-plaintext highlighter-rouge">/opt/example.com/tomcat7/webapps</code>) to serve all content at the root context path.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Service</span> <span class="na">name=</span><span class="s">"example"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"9090"</span> <span class="na">protocol=</span><span class="s">"HTTP/1.1"</span> <span class="na">connectionTimeout=</span><span class="s">"20000"</span>
            <span class="na">URIEncoding=</span><span class="s">"UTF-8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Engine</span> <span class="na">name=</span><span class="s">"example"</span> <span class="na">defaultHost=</span><span class="s">"localhost"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">"localhost"</span> <span class="na">appBase=</span><span class="s">"/opt/example.com/tomcat7/webapps"</span>
                <span class="na">unpackWARs=</span><span class="s">"true"</span> <span class="na">autoDeploy=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">"org.apache.catalina.valves.AccessLogValve"</span>
                    <span class="na">directory=</span><span class="s">"logs"</span> <span class="na">prefix=</span><span class="s">"example.com_access_log."</span>
                    <span class="na">suffix=</span><span class="s">".txt"</span> <span class="na">pattern=</span><span class="s">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/Host&gt;</span>
    <span class="nt">&lt;/Engine&gt;</span>
<span class="nt">&lt;/Service&gt;</span>
</code></pre></div></div>

<h2 id="how-does-tomcat-know-the-subdomain">How does Tomcat Know the Subdomain?</h2>

<p>With this configuration, all content will be sent to Tomcat with “localhost” as the hostname. Fortunately, the <a href="https://httpd.apache.org/docs/current/mod/mod_proxy.html#x-headers">Apache reverse proxy will send extra request headers</a> to Tomcat, namely:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>: The IP address of the client.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code>: The original host requested by the client in the Host HTTP request header.</strong></li>
  <li><code class="language-plaintext highlighter-rouge">X-Forwarded-Server</code>: The hostname of the proxy server.</li>
</ul>

<p>So in Tomcat (or any other servlet container), just use the Java code below to get the value of that header <code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code> and you’ll know the subdomain.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">subdomain</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"X-Forwarded-Host"</span><span class="o">);</span>
</code></pre></div></div>

<p>Alternatively, you may also use the <a href="https://httpd.apache.org/docs/current/mod/mod_proxy.html#proxypreservehost">ProxyPreserveHost</a> On directive in Apache configuration and you should be able to get the hostname (subdomain) normally in Tomcat. <em>NOTE: I haven’t tested that setup.</em></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">subdomain</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerName</span><span class="o">();</span>
</code></pre></div></div>

<h2 id="bonus-wildcard-ssl-certificate">Bonus: Wildcard SSL Certificate</h2>

<p>Of course you’ll need a wildcard SSL certificate. Those are usually very expensive, but <a href="https://www.namecheap.com/security/ssl-certificates/comodo/positivessl-wildcard.aspx">Namecheap resells Comodo wildcard certificate at very good price</a>. No, I do not have any interest in namecheap, they just happen to be very good at what they do 🙂</p>

<p><em>Author: <a href="https://www.linkedin.com/in/jonathan-demers-ing" title="Jonathan Demers">Jonathan Demers</a></em></p>

  </div><a class="u-url" href="/tech/https-wildcard-subdomain-dns-apache-tomcat-config/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">OpCode Tech</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">OpCode Tech</li><li><a class="u-email" href="mailto:jdemers@opcodesolutions.com">jdemers@opcodesolutions.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/JonDemers"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">JonDemers</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Optimize Your Processes</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
